# 📖 自动小说生成工具

# AI_NovelGenerator (CNlaojing Fork)  
> 基于 YILING0013/AI_NovelGenerator 的中文本地化增强版本，新增多模型适配与向量库优化功能  
## 📌 项目说明  
本项目是 [YILING0013/AI_NovelGenerator](https://github.com/YILING0013/AI_NovelGenerator)  的 Fork 分支，由 CNlaojing 维护。 
✨ **核心功能** ✨

| 功能模块          | 关键能力                          |
|-------------------|----------------------------------|
| 🎨 小说设定工坊    | 世界观架构 / 角色设定 / 剧情蓝图   |
| 📖 智能章节生成    | 多阶段生成保障剧情连贯性           |
| 🧠 状态追踪系统    | 角色发展轨迹 / 伏笔管理系统         |
| 🔍 语义检索引擎    | 基于向量的长程上下文一致性维护      |
| 📚 知识库集成      | 支持本地文档参考         |
| ✅ 自动审校机制    | 检测剧情矛盾与逻辑冲突          |
| 🖥 可视化工作台    | 全流程GUI操作，配置/生成/审校一体化 |

</div>

> 一款基于大语言模型的多功能小说生成器，助您高效创作逻辑严谨、设定统一的长篇故事

## 🔄 更新日志
- 2025-06-01
- V1.5.0 (2025-06-01)
  - 完善角色状态自动更新
  - 优化伏笔追踪系统
  - 修复章节草稿生成bug
  - 定稿后自动更新章节号
1、每个主要步骤添加了提示词编辑窗并附带字数显示，用户可根据自己的喜好，修改提示词后，点击生成即可调用LLM生成对应内容
2、修改主要步骤的提示词与生成格式，包括但不限于：分卷大纲、章节目录、章节草稿、小说改写、章节定稿、剧情要点、前情摘要等
3、因没有完善的提示词进行向量库检索出对于生成小说设定、分卷大纲、章节目录、章节正文、定稿等情况下有用的知识库内容，所以删除了导入知识库与知识库检索功能
4、将向量库修改为角色数据库与伏笔向量库，角色向量库用于存储角色的基本信息，伏笔向量库用于存储伏笔的状态信息
5、角色状态与伏笔状态均使用唯一编号进行检索与向量化
6、修改分卷大纲生成方式
   - 生成第1卷时，会根据用户填写的数量，生成第1卷所需的角色基础状态进提示词
   - 生成后续卷时，会根据用户填写权重数值，检索向量库内≥阈值的角色状态进提示词
     注意：推荐生成完整第一卷章节正文后，再使用最新状态的角色状态作为提示词生成后续分卷大纲
7、修改生成目录生成方式
   - 由用户填写的数量来按段生成对应章节目录
   - 由用户填写的权重数值，检索向量库内≥阈值的角色状态进提示词
   - 修改章节目录格式，新增伏笔系统
     注意：推荐生成完整一段目录章节正文后，在使用对应的角色状态作为提示词生成后续章节目录
   章节目录的伏笔系统
      - 修改章节目录格式，主要添加伏笔条目
      - 伏笔条目会根据已有伏笔的编号与状态增量添加，确保伏笔状态能衔接
   章节目录提取角色状态
      - 生成章节目前，根据用户填写的数值来提取当前最新章节前N章有出场，且权重数值≥阈值的角色状态
      - 根据角色数据库检索出所需角色ID，使用角色ID从向量库检索出角色状态进提示词
8、一致性审校提示词修改
   - 一致性审校后，将把审校结果保存至一次性审校.txt文件中
9、新增改写章节功能
   - 改写章节提取一次性审校内容，使用一次性审校内容作为改写提示词
   - 改写章节后，会自动更新对应章节正文文件
10、定稿章节功能
   - 删除定稿时字数检验，更改为独立的改写章节功能
   - 修改定稿时提取的前情摘要提示词与格式
   - 修改定稿时检索角色状态的方式与格式，并向量化最终角色进入向量库
   - 新增定稿时检索章节对应伏笔并把伏笔内容更新至伏笔向量库、
   - 修改定稿时剧情要点的提取的提示词与格式
11、修改角色库功能
   - 修改角色库内角色的格式等
         
- 2023-04-12 添加分卷功能，按分卷生成章节目录，修复剧情要点
- 2023-03-09 添加字数显示
- 2023-03-05 添加角色库功能
---
##  生成小说步骤推荐
开始  
│<br>  
├─▶ 1. 生成小说设定<br>  
│<br>  
├─▶ 2. 生成第一卷大纲<br>  
│    ├─ 2.1 生成第一段章节目录<br>  
│    │   ├─ 2.1.1 生成章节草稿<br>  
│    │   ├─ 2.1.2 故事逻辑审校<br>  
│    │   ├─ 2.1.3 AI改写优化<br>  
│    │   └─ 2.1.4 章节定稿<br>  
│    ├─ 2.2 生成第二段章节目录（使用已有的高权重角色状态生成第二段章节目录）<br>  
│    │   └──▶ 循环执行2.1.1-2.1.4流程<br>  
│    └─ 2.3 卷终审核<br>  
│         ├─ 情节连贯性检测<br>  
│         └─ 世界观一致性验证<br>  
├─▶ 3. 生成第二卷大纲（使用已有的高权重角色状态生成第二卷分卷大纲）<br>  
│    └──▶ 重复执行2.1-2.3流程<br>  
├─▶ 4. 生成第三卷大纲<br>  
│    └──▶ 重复执行2.1-2.3流程<br>  
│      ...<br>  
├─▶ N. 最终卷<br>  
└─▶ 完成小说创作

## 📑 目录导航
1. [环境准备](#-环境准备)  
2. [安装说明](#-安装说明)
3. [项目架构](#-项目架构)  
4. [配置指南](#⚙️-配置指南)  
5. [运行说明](#-运行说明)  
6. [使用教程](#-使用教程)  
7. [疑难解答](#-疑难解答)  

---

## 🛠 环境准备
确保满足以下运行条件：
- **Python 3.9+** 运行环境（推荐3.10-3.12之间）
- **pip** 包管理工具
- 有效API密钥：
  - 云端服务：OpenAI / DeepSeek 等
  - 本地服务：Ollama 等兼容 OpenAI 的接口

---

## 📥 安装说明
1. **下载项目**  
   - 通过 [GitHub](https://github.com) 下载项目 ZIP 文件，或使用以下命令克隆本项目：
     ```bash
     git clone https://github.com/YILING0013/AI_NovelGenerator
     上述仓库如不是本版本，也可用以下载Fork分支
     git clone https://github.com/CNlaojing/AI_NovelGenerator

     ```

2. **安装编译工具（可选）**  
   - 如果对某些包无法正常安装，访问 [Visual Studio Build Tools](https://visualstudio.microsoft.com/zh-hans/visual-cpp-build-tools/) 下载并安装C++编译工具，用于构建部分模块包；
   - 安装时，默认只包含 MSBuild 工具，需手动勾选左上角列表栏中的 **C++ 桌面开发** 选项。

3. **安装依赖并运行**  
   - 打开终端，进入项目源文件目录：
     ```bash
     cd AI_NovelGenerator
     ```
   - 安装项目依赖：
     ```bash
     pip install -r requirements.txt
     ```
   - 安装完成后，运行主程序：
     ```bash
     python main.py
     ```

>如果缺失部分依赖，后续**手动执行**
>```bash
>pip install XXX
>```
>进行安装即可

## 🗂 项目架构
```
AI_NovelGenerator/
├─main.py                      # 入口文件, 运行 GUI
├─ui/                          # 图形界面模块
│  ├─main_window.py            # 主窗口
│  ├─chapters_tab.py           # 章节管理标签页
│  ├─character_tab.py          # 角色管理标签页
│  └─...                       # 其他UI组件
├─novel_generator/             # 核心生成模块
│  ├─architecture.py           # 小说架构生成
│  ├─chapter.py                # 章节生成
│  ├─character_generator.py    # 角色生成
│  ├─consistency_checker.py    # 一致性检查
│  ├─vectorstore_utils.py      # 向量库工具
│  └─...                       # 其他生成组件
├─llm_adapters.py              # LLM 接口封装
├─embedding_adapters.py        # Embedding 接口封装
├─prompt_definitions.py        # 定义 AI 提示词
├─utils.py                     # 常用工具函数
├─config_manager.py            # 管理配置
├─config.json                  # 用户配置文件
└─requirements.txt             # 项目依赖
```

---

## ⚙️ 配置指南
### 📌 基础配置（config.json）
```json
{
    "api_key": "sk-XXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",
    "base_url": "https://api.openai.com/v1",
    "interface_format": "OpenAI",
    "model_name": "gpt-4o-mini",
    "temperature": 0.7,
    "max_tokens": 4096,
    "embedding_api_key": "sk-XXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",
    "embedding_interface_format": "OpenAI",
    "embedding_url": "https://api.openai.com/v1",
    "embedding_model_name": "text-embedding-ada-002",
    "embedding_retrieval_k": 4,
    "topic": "星穹铁道主角王德发，穿越到原神提瓦特大陆，拯救提瓦特大陆，并与其中的角色展开爱恨情仇的小说",
    "genre": "玄幻",
    "num_chapters": 120,
    "word_number": 4000,
    "filepath": "D:/AI_NovelGenerator/filepath"
}
```

### 🔧 配置说明
1. **生成模型配置**
   - `api_key`: 大模型服务的API密钥
   - `base_url`: API终端地址（本地服务填Ollama等地址）
   - `interface_format`: 接口模式（OpenAI/DeepSeek/Ollama等）
   - `model_name`: 主生成模型名称（如gpt-4, claude-3等）
   - `temperature`: 创意度参数（0-1，越高越有创造性）
   - `max_tokens`: 模型最大回复长度
   - `timeout`: 请求超时时间（秒）

2. **Embedding模型配置**
   - `embedding_api_key`: 向量嵌入服务的API密钥
   - `embedding_interface_format`: 嵌入接口模式
   - `embedding_url`: 嵌入服务地址
   - `embedding_model_name`: 嵌入模型名称（如text-embedding-ada-002）
   - `embedding_retrieval_k`: 检索时返回的相似文档数量

3. **小说参数配置**
   - `topic`: 核心故事主题
   - `genre`: 作品类型（如科幻、奇幻、武侠等）
   - `num_chapters`: 总章节数
   - `word_number`: 单章目标字数
   - `filepath`: 生成文件存储路径

---

## 🚀 运行说明
### **方式 1：使用 Python 解释器**
```bash
python main.py
```
执行后，GUI 将会启动，你可以在图形界面中进行各项操作。

### **方式 2：打包为可执行文件**
如果你想在无 Python 环境的机器上使用本工具，可以使用 **PyInstaller** 进行打包：

```bash
pip install pyinstaller
pyinstaller main.spec
```
打包完成后，会在 `dist/` 目录下生成可执行文件（如 Windows 下的 `main.exe`）。

---

## 📘 使用教程

### 1. 初始配置
1. **启动软件**
   - 双击`main.py`或在命令行中运行`python main.py`
   - 软件启动后会显示主界面，包含多个功能标签页

2. **配置API参数**
   - 点击顶部的"配置"标签页
   - 在左侧选择LLM接口格式（OpenAI/DeepSeek/Ollama等）
   - 填写相应的API密钥（API Key）
   - 填写API基础URL（如OpenAI为https://api.openai.com/v1）
   - 选择模型名称（如gpt-4o-mini、gpt-3.5-turbo等）
   - 设置温度参数（Temperature，0.1-1.0，越低越保守）
   - 设置最大生成长度（Max Tokens，建议4096-8192）
   - 设置超时时间（Timeout，建议600秒）

3. **配置Embedding参数**
   - 在同一标签页右侧设置Embedding参数
   - 选择Embedding接口格式（通常与LLM相同）
   - 填写Embedding API密钥（可与LLM相同）
   - 填写Embedding基础URL
   - 选择Embedding模型（如text-embedding-ada-002）
   - 设置检索数量（Retrieval K，建议4-8）

4. **设置保存路径**
   - 点击"浏览"按钮选择一个空白目录作为项目保存路径
   - 确保该目录有足够的空间和写入权限
   - 点击"保存配置"按钮保存所有设置

5. **测试配置**
   - 点击"测试LLM配置"和"测试Embedding配置"按钮
   - 确认配置正确，测试结果显示"成功"后再进行下一步

### 2. 项目创建
1. **填写小说基本信息**
   - 点击"小说参数"标签页
   - 填写主题/Topic（如"废土世界的AI叛乱"）
   - 选择类型/Genre（如"科幻"、"奇幻"、"武侠"等）
   - 设置总章节数
   - 设置每章字数
   - 设置分卷数量
   
2. **添加创作指导**
   - 在"用户指导"文本框中添加创作风格、内容限制等要求
   - 可以指定特定的写作风格、禁忌内容、核心人物等
   - 这些指导将贯穿整个创作过程

### 3. 小说生成步骤

1. **生成小说架构**
   - 点击主页标签页上的"生成小说架构"按钮
   - 系统开始自动生成以下内容（过程可能需要几分钟）:
     - 核心种子：小说的核心概念和主题
     - 角色动力学：主要角色关系和冲突
     - 世界观设定：故事发生的背景和规则
     - 三幕式架构：整体剧情框架
   - 生成完成后，点击"小说架构"标签页查看详细内容
   - 如果对设定不满意，可以在“小说架构”页面编辑后点击"保存设定"按钮

2. **生成分卷大纲**
   - 在主页标签页点击"生成分卷"按钮
   - 系统根据之前设置的分卷数量生成分卷的主要内容和主题
   - 当生成第1卷时，会根据用户填写的数量先生成第1卷所需的角色基础状态进提示词
   - 当生成后续卷时，会根据用户填写权重数值，检索向量库内≥阈值的角色状态进提示词
   - 在提示词弹窗修改好提示词后，确认生成即可调用LLM生成对应分卷大纲
   - 以此类推，直到生成所有分卷
   - 生成完成后，点击"小说分卷"标签页查看结果
   - 每个分卷包含主题、核心冲突、关键角色和主要事件
   - 可以在分卷页面编辑内容并点击"保存修改"按钮
   - 为了小说整体连贯，建议在生成第1卷分卷大纲后，完成所有第1卷章节正文后再生成后续分卷，以便系统可根据最新的角色状态，生成后续分卷大纲

3. **生成章节目录**
   在主页标签页点击"生成目录"按钮，会弹出确认窗口
   确认窗口参数：
      - 按数量生成：指定要生成的章节数量，推荐20章以下
      - 设置角色提取参数（前N章和权重阈值）
      - 系统会根据用户设置的参数，检索角色数据库.txt文件中，提取前N章中有出场≥阈值的ID
      - 根据角色ID检索向量库内≥阈值的角色状态进提示词
   提示词编辑窗：
      - 弹出提示词编辑窗前，系统会分析已生成的“角色状态.txt”文件，分析出已有章节的伏笔状态
      - 包含：
         - 当前所有未回收伏笔的基本信息，
         - 当前每种类型伏笔的最大编号，
         - 现需生成范围内必须回收的伏笔的状态
         - 提示词编辑窗内，会根据角色ID检索向量库内≥阈值的角色状态进提示词
      - 用户修改好提示词后，确认生成即可调用LLM生成对应数量章节目录，并按照最新角色状态、前三章章节目录、小说分卷、伏笔历史信息等设定来确保后续章节大纲能够衔接
   - 系统会根据每次生成完成的章节大纲，自动分析伏笔状态，并更新“伏笔状态.txt”文件中
   - 生成完成后，点击"小说目录"标签页查看结果
   - 目录包含每章的标题、简要描述和涉及角色
   - 修改章节目录后，可点击生成目录按钮，即可自动清空旧版的”伏笔状态.txt”文件，重新生成新的伏笔状态
   - 可以在目录页面编辑内容并点击"保存目录"按钮

4. **生成章节草稿**
   - 主界面章节号编辑框填写需要生成的章节号
   - 点击"生成草稿"按钮
   - 系统会先分析当前章节基本信息、分卷大纲、前情摘要、角色数据库等信息分析生成草稿所需的角色信息
   - 分析内容：
      - 从角色数据库中分析出本章需要的角色并提取该角色ID
      - 除角色数据库内的角色外，是否需要增加新的角色
      - 使用LLM生成本章所需新角色的基本信息，并导入待用角色文件
      - 使用角色ID检索向量库，提取向量库内的角色状态并导入待用角色文件
      - 将待用角色文件内的角色状态，填充进生成草稿提示词内，并弹出编辑框
   - 用户修改好提示词后，确认生成即可调用LLM生成对应章节草稿
   - 生成完成后，草稿会保存至保存路径下的文件夹中并显示在右侧编辑框中供用户改写、一致性审校、定稿等操作
   - 点击“章节正文”标签页查看章节正文结果
   - 修改后点击"保存"按钮保存当前版本

5. **一致性审校**
   - 在主界面点击“一致性审校”按钮
   - 系统根据当前审校章节的基本信息，分析出本章伏笔的伏笔编号
   - 根据伏笔编号，检索向量库，提取对应伏笔的历史信息填充进提示词，
   - 提示词包含：章节基本信息、分卷大纲、前情摘要、上一章剧情要点、伏笔的历史内容等
   - 根据提示词，调用LLM进行内容一致性审校
     - 角色行为是否符合设定
     - 情节是否与前文连贯
     - 世界观设定是否一致
     - 伏笔是否符合设计原则，是否与历史伏笔有效衔接
   - 审校完成后，会把审校结果保存至一致性审校文件夹内

6. **章节改写**
   - 在主界面点击“改写章节”按钮
   - 系统会根据当前章节的基本信息，并提取一致性审校文件夹内的审校结果进提示词
   - 在弹出的改写提示词窗口中查看提示词是否符合预期或输入改写指导（如改变风格、增加细节等）
   - 点击"确认改写"按钮开始改写
   - 改写完成后，新版本会显示在编辑框中并覆盖保存至对应文件中

7. **章节定稿**
   - 确认内容编辑框内的内容已经满意
   - 或者复制修改后的内容至内容编辑框内
   - 填写正确的章节号
   - 点击"定稿章节"按钮
   - 系统会执行以下操作：
     - 提取章节中的剧情要点
     - 检索本章出现的角色，并检索角色数据库内已有角色ID
     - 从向量库检索本章已有角色状态，并更新角色状态
     - 删除向量库内本章角色状态，并把更新后的角色状态与新角色一起向量化进角色向量库内
     - 提取本章伏笔的历史伏笔内容，分析出本章伏笔内容，并整合
     - 删除伏笔向量库内对应伏笔内容，并把整合后的伏笔内容与新伏笔一起向量化进伏笔向量库内

8. **管理角色库**
   - 系统会根据生成的内容自动提取小说中的角色
   - 点击类型标签页按钮看所有角色信息
   - 支持手动添加新角色：点击角色对应权重按钮，即可生成对应权重新角色基本格式
   - 支持编辑现有角色：点击角色行后的"编辑"按钮
   - 支持删除角色：点击角色行后的"删除"按钮
   - 编辑完成后点击"保存角色库"按钮

9. **后期修改**
   - 可随时修改已定稿章节：
     - 在章节页面选择需要修改的章节
     - 编辑内容后点击"保存草稿"按钮
     - 如有必要，可以重新进行章节改写
     - 如非必要，请勿重新定稿非最新章节
   - 注意：重新定稿非最新章节可能会影响伏笔与角色状态的连贯性

---

## ❓ 疑难解答

### API和连接问题

#### Q1: 出现 "Expecting value: line 1 column 1 (char 0)" 错误
该问题通常由API未正确响应造成，可能是API返回了HTML或其他非JSON内容。

**解决方法**：
- 检查API密钥是否正确输入，没有多余的空格或换行
- 确认API服务是否可用（可访问官方状态页面查看）
- 检查API基础URL是否正确（例如OpenAI应为https://api.openai.com/v1）
- 尝试更换API服务提供商
- 检查网络连接，确保没有代理或防火墙阻止
- 重启软件，重新加载配置

#### Q2: 出现 "HTTP/1.1 504 Gateway Timeout" 或其他超时错误
这表明API服务器响应超时，可能是网络问题或服务器负载过高。

**解决方法**：
- 确认网络连接稳定，尝试ping API服务器
- 检查API服务是否正常运行（查看官方状态页面）
- 在配置页面增加超时参数值（建议设置为600秒或更高）
- 减小生成内容的长度（降低max_tokens值）
- 尝试在网络状况较好的时段使用
- 如使用代理，检查代理服务是否稳定

#### Q3: 模型返回内容不完整或被截断
这通常是因为模型生成的内容超过了设定的最大token限制。

**解决方法**：
- 增加max_tokens参数值（在配置页面调整）
- 减少每章的目标字数
- 使用支持更长上下文的模型（如gpt-4-turbo）
- 将长章节拆分为多个较短的章节

#### Q3: 检索向量库或者更新向量库弹错

**解决方法**：
- 填写正确的Embedding API密钥等信息，并测试配置
- 检索向量库使用的嵌入模型维度需与更新向量库使用的嵌入模型维度一致，如：768对应768,1024对应1024
- 检查使用的模型是否支持长文本嵌入，可更换为本地ollama，或者免费的硅基流动BAAI/bge-m3模型

### 功能和使用问题

#### Q4: 如何切换不同的LLM或Embedding提供商？

**解决方法**：
1. 点击"配置"标签页
2. 在左侧LLM配置区域，选择不同的接口格式：
   - OpenAI（支持GPT系列模型）
   - DeepSeek（支持DeepSeek系列模型）
   - Ollama（支持本地部署的开源模型）
   - 智谱AI（支持GLM系列模型）
   - 火山引擎（支持火山引擎提供的模型）
3. 填写相应的API密钥和基础URL
4. 选择适合的模型名称
5. 同样方式配置右侧的Embedding参数
6. 点击"保存配置"按钮
7. 使用"测试LLM配置"和"测试Embedding配置"按钮验证配置是否正确

#### Q5: 生成的内容质量不理想，如何提高？

**解决方法**：
- 使用更强大的模型（如GPT-4、Claude-3等）
- 调整temperature参数（降低至0.1-0.5可获得更稳定输出）
- 在"小说参数"页面提供更详细的用户指导和创作要求
- 在生成章节前，确保小说设定、分卷大纲和章节目录内容丰富且连贯
- 利用一致性审校功能检查并修正问题
- 导入相关知识库资料提供参考（如历史背景、专业知识等）
- 对重要章节使用改写功能，提供具体的改进指导

#### Q6: 生成速度太慢，如何加快？

**解决方法**：
- 使用本地部署的模型（如通过Ollama运行Llama、Mistral等模型）
- 减小每章的目标字数（在"小说参数"页面调整）
- 降低max_tokens参数值（但注意不要太低导致内容被截断）
- 使用响应更快的API服务或选择更快的模型（如gpt-3.5-turbo）
- 确保网络连接稳定，可能的话使用有线连接
- 关闭不必要的应用程序，释放系统资源

#### Q7: 角色库中的角色信息丢失或不一致

**解决方法**：
- 检查"角色数据库.txt"文件是否存在且格式正确
- 在角色标签页中手动添加或编辑丢失的角色信息
- 确保每次编辑后点击"保存角色库"按钮
- 避免在多个实例中同时编辑角色信息
- 如果问题严重，可以从备份中恢复角色数据库文件

#### Q8: 文件保存路径问题

**解决方法**：
- 确保在配置页面设置了有效的文件保存路径
- 检查该路径是否有写入权限
- 避免使用包含特殊字符的路径
- 如果路径太长，尝试使用更短的路径
- 确保磁盘有足够的空间

---

---

如有更多问题或需求，欢迎在 
[项目Issues](https://github.com/YILING0013/AI_NovelGenerator/issues) 
[项目Issues](https://github.com/CNlaojing/AI_NovelGenerator/issues) 
中提出。
